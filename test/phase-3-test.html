<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phase 3: Duplicate Detection & File Operations - Test Client</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #7f8c8d;
            margin-bottom: 30px;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section h2 {
            color: #34495e;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .test-group {
            margin-bottom: 20px;
        }

        .test-group h3 {
            color: #555;
            margin-bottom: 10px;
        }

        button {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px 5px 5px 0;
            transition: background 0.3s;
        }

        button:hover {
            background: #2980b9;
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        button.success {
            background: #27ae60;
        }

        button.success:hover {
            background: #229954;
        }

        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 5px 5px 0;
            font-size: 14px;
        }

        input[type="text"], input[type="number"] {
            min-width: 300px;
        }

        input[type="checkbox"] {
            margin-right: 5px;
        }

        .result {
            margin-top: 10px;
            padding: 15px;
            border-radius: 5px;
            background: #ecf0f1;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }

        .result.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .result.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }

        .stat-card h4 {
            color: #555;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .stat-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
        }

        .duplicate-group {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .duplicate-group h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .track-item {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
        }

        .track-item.canonical {
            border-color: #28a745;
            border-width: 2px;
        }

        .track-item .path {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #555;
            font-weight: 500;
        }

        .inline-form {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .server-status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .server-status.online {
            background: #d4edda;
            color: #155724;
        }

        .server-status.offline {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Phase 3: Duplicate Detection & File Operations</h1>
        <p class="subtitle">Test Client for Days 9-11 Features | Server: <span id="serverStatus" class="server-status">Checking...</span></p>

        <!-- Track Management Section -->
        <div class="section">
            <h2>1. Track Management</h2>

            <div class="test-group">
                <h3>Get All Tracks</h3>
                <div class="inline-form">
                    <input type="number" id="trackPage" placeholder="Page (default: 1)" value="1">
                    <input type="number" id="trackLimit" placeholder="Limit (default: 50)" value="20">
                    <button onclick="getAllTracks()">Get Tracks</button>
                </div>
                <div id="tracksResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>Get Track by ID</h3>
                <div class="inline-form">
                    <input type="number" id="trackIdInput" placeholder="Track ID">
                    <button onclick="getTrackById()">Get Track</button>
                </div>
                <div id="trackByIdResult" class="result"></div>
            </div>
        </div>

        <!-- Duplicate Detection Section -->
        <div class="section">
            <h2>2. Duplicate Detection</h2>

            <div class="test-group">
                <h3>Duplicate Statistics</h3>
                <button onclick="getDuplicateStats()">Get Duplicate Stats</button>
                <div id="duplicateStatsResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>Scan Library for Duplicates</h3>
                <button onclick="scanForDuplicates()">Scan for Duplicates</button>
                <div id="scanDuplicatesResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>List Duplicate Groups</h3>
                <div class="inline-form">
                    <input type="number" id="dupPage" placeholder="Page" value="1">
                    <input type="number" id="dupLimit" placeholder="Limit" value="10">
                    <button onclick="getDuplicateGroups()">Get Duplicate Groups</button>
                </div>
                <div id="duplicateGroupsResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>Get Duplicate Group Details</h3>
                <div class="inline-form">
                    <input type="number" id="groupIdInput" placeholder="Group ID">
                    <button onclick="getDuplicateGroup()">Get Group Details</button>
                </div>
                <div id="duplicateGroupResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>Resolve Duplicate Group</h3>
                <div class="inline-form">
                    <input type="number" id="resolveGroupId" placeholder="Group ID">
                    <input type="number" id="resolveCanonicalId" placeholder="Canonical Track ID">
                    <label><input type="checkbox" id="resolveDeleteFiles"> Delete Files</label>
                    <label><input type="checkbox" id="resolveKeepMetadata" checked> Keep Metadata</label>
                    <label><input type="checkbox" id="resolveUpdatePlaylists" checked> Update Playlists</label>
                    <button class="danger" onclick="resolveDuplicates()">Resolve Duplicates</button>
                </div>
                <div id="resolveDuplicatesResult" class="result"></div>
            </div>
        </div>

        <!-- File Operations Section -->
        <div class="section">
            <h2>3. File Operations</h2>

            <div class="test-group">
                <h3>Verify Track File</h3>
                <div class="inline-form">
                    <input type="number" id="verifyTrackId" placeholder="Track ID">
                    <button onclick="verifyTrack()">Verify File</button>
                </div>
                <div id="verifyResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>Move Track</h3>
                <div class="form-group">
                    <label>Track ID:</label>
                    <input type="number" id="moveTrackId" placeholder="Track ID">
                </div>
                <div class="form-group">
                    <label>Destination Path:</label>
                    <input type="text" id="moveDestPath" placeholder="/path/to/new/location/file.mp3">
                </div>
                <div class="form-group">
                    <label>Library Directory ID (optional):</label>
                    <input type="number" id="moveLibraryId" placeholder="Leave empty for same library">
                </div>
                <button class="danger" onclick="moveTrack()">Move Track</button>
                <div id="moveResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>Rename Track</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                    <strong>Note:</strong> Extension is preserved from original file. Enter name without extension.
                </p>
                <div class="inline-form">
                    <input type="number" id="renameTrackId" placeholder="Track ID">
                    <input type="text" id="renameNewName" placeholder="new-filename (no extension)">
                    <button class="danger" onclick="renameTrack()">Rename Track</button>
                </div>
                <div id="renameResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>Delete Track</h3>
                <div class="inline-form">
                    <input type="number" id="deleteTrackId" placeholder="Track ID">
                    <label><input type="checkbox" id="deleteConfirm"> I confirm deletion</label>
                    <button class="danger" onclick="deleteTrack()">Delete Track & File</button>
                </div>
                <div id="deleteResult" class="result"></div>
            </div>
        </div>

        <!-- Directory Browser & Missing Media Section -->
        <div class="section">
            <h2>4. Directory Browser & Missing Media</h2>

            <div class="test-group">
                <h3>Browse Library Directory</h3>
                <div class="form-group">
                    <label>Library Directory ID:</label>
                    <input type="number" id="browseLibraryId" placeholder="Library Directory ID" value="1">
                </div>
                <div class="form-group">
                    <label>Relative Path (optional):</label>
                    <input type="text" id="browseRelativePath" placeholder="Leave empty for root">
                </div>
                <button onclick="browseDirectory()">Browse Directory</button>
                <div id="browseResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>Missing Track Statistics</h3>
                <div class="inline-form">
                    <input type="number" id="missingStatsLibraryId" placeholder="Library Directory ID" value="1">
                    <button onclick="getMissingStats()">Get Missing Stats</button>
                </div>
                <div id="missingStatsResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>List Missing Tracks</h3>
                <div class="inline-form">
                    <input type="number" id="missingTracksLibraryId" placeholder="Library Directory ID" value="1">
                    <input type="number" id="missingTracksPage" placeholder="Page" value="1">
                    <input type="number" id="missingTracksLimit" placeholder="Limit" value="20">
                    <button onclick="getMissingTracks()">Get Missing Tracks</button>
                </div>
                <div id="missingTracksResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>Cleanup Missing Tracks</h3>
                <p style="color: #666; font-size: 14px; margin-bottom: 10px;">
                    <strong>Warning:</strong> This removes tracks missing for more than the specified days from the database.
                </p>
                <div class="inline-form">
                    <input type="number" id="cleanupLibraryId" placeholder="Library Directory ID" value="1">
                    <input type="number" id="cleanupOlderThan" placeholder="Older than days" value="30">
                    <label><input type="checkbox" id="cleanupKeepPlaylists" checked> Keep Playlists Intact</label>
                    <label><input type="checkbox" id="cleanupBackup" checked> Backup Metadata</label>
                    <button class="danger" onclick="cleanupMissingTracks()">Cleanup Missing</button>
                </div>
                <div id="cleanupResult" class="result"></div>
            </div>

            <div class="test-group">
                <h3>Restore Tracks</h3>
                <div class="inline-form">
                    <input type="number" id="restoreLibraryId" placeholder="Library Directory ID" value="1">
                    <button class="success" onclick="restoreTracks()">Restore Tracks</button>
                </div>
                <div id="restoreResult" class="result"></div>
            </div>
        </div>

        <!-- Run All Tests Section -->
        <div class="section">
            <h2>5. Run All Tests</h2>
            <button class="success" onclick="runAllTests()">Run All Tests</button>
            <div id="allTestsResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3000/api';

        // Check server status on load
        async function checkServerStatus() {
            try {
                const response = await fetch('http://localhost:3000/health');
                const data = await response.json();
                document.getElementById('serverStatus').textContent = 'Online';
                document.getElementById('serverStatus').className = 'server-status online';
            } catch (error) {
                document.getElementById('serverStatus').textContent = 'Offline';
                document.getElementById('serverStatus').className = 'server-status offline';
            }
        }

        // Helper to display results
        function displayResult(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = JSON.stringify(data, null, 2);
            element.className = isError ? 'result error' : 'result success';
        }

        // Track Management
        async function getAllTracks() {
            try {
                const page = document.getElementById('trackPage').value || 1;
                const limit = document.getElementById('trackLimit').value || 20;
                const response = await fetch(`${API_BASE}/tracks?page=${page}&limit=${limit}`);
                const data = await response.json();
                displayResult('tracksResult', data);
            } catch (error) {
                displayResult('tracksResult', { error: error.message }, true);
            }
        }

        async function getTrackById() {
            try {
                const id = document.getElementById('trackIdInput').value;
                if (!id) throw new Error('Track ID required');
                const response = await fetch(`${API_BASE}/tracks/${id}`);
                const data = await response.json();
                displayResult('trackByIdResult', data, !response.ok);
            } catch (error) {
                displayResult('trackByIdResult', { error: error.message }, true);
            }
        }

        // Duplicate Detection
        async function getDuplicateStats() {
            try {
                const response = await fetch(`${API_BASE}/duplicates/stats`);
                const data = await response.json();
                displayResult('duplicateStatsResult', data);
            } catch (error) {
                displayResult('duplicateStatsResult', { error: error.message }, true);
            }
        }

        async function scanForDuplicates() {
            try {
                const response = await fetch(`${API_BASE}/duplicates/scan`, { method: 'POST' });
                const data = await response.json();
                displayResult('scanDuplicatesResult', data);
            } catch (error) {
                displayResult('scanDuplicatesResult', { error: error.message }, true);
            }
        }

        async function getDuplicateGroups() {
            try {
                const page = document.getElementById('dupPage').value || 1;
                const limit = document.getElementById('dupLimit').value || 10;
                const response = await fetch(`${API_BASE}/duplicates?page=${page}&limit=${limit}`);
                const data = await response.json();
                displayResult('duplicateGroupsResult', data);
            } catch (error) {
                displayResult('duplicateGroupsResult', { error: error.message }, true);
            }
        }

        async function getDuplicateGroup() {
            try {
                const id = document.getElementById('groupIdInput').value;
                if (!id) throw new Error('Group ID required');
                const response = await fetch(`${API_BASE}/duplicates/${id}`);
                const data = await response.json();
                displayResult('duplicateGroupResult', data, !response.ok);
            } catch (error) {
                displayResult('duplicateGroupResult', { error: error.message }, true);
            }
        }

        async function resolveDuplicates() {
            try {
                const groupId = document.getElementById('resolveGroupId').value;
                const canonicalId = document.getElementById('resolveCanonicalId').value;
                const deleteFiles = document.getElementById('resolveDeleteFiles').checked;
                const keepMetadata = document.getElementById('resolveKeepMetadata').checked;
                const updatePlaylists = document.getElementById('resolveUpdatePlaylists').checked;

                if (!groupId || !canonicalId) {
                    throw new Error('Group ID and Canonical Track ID required');
                }

                const response = await fetch(`${API_BASE}/duplicates/${groupId}/resolve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        canonicalTrackId: parseInt(canonicalId),
                        deleteFiles,
                        keepMetadata,
                        updatePlaylists
                    })
                });

                const data = await response.json();
                displayResult('resolveDuplicatesResult', data, !response.ok);
            } catch (error) {
                displayResult('resolveDuplicatesResult', { error: error.message }, true);
            }
        }

        // File Operations
        async function verifyTrack() {
            try {
                const id = document.getElementById('verifyTrackId').value;
                if (!id) throw new Error('Track ID required');
                const response = await fetch(`${API_BASE}/tracks/${id}/verify`);
                const data = await response.json();
                displayResult('verifyResult', data, !response.ok);
            } catch (error) {
                displayResult('verifyResult', { error: error.message }, true);
            }
        }

        async function moveTrack() {
            try {
                const trackId = document.getElementById('moveTrackId').value;
                const destPath = document.getElementById('moveDestPath').value;
                const libraryId = document.getElementById('moveLibraryId').value;

                if (!trackId || !destPath) {
                    throw new Error('Track ID and Destination Path required');
                }

                const body = { destination_path: destPath };
                if (libraryId) body.library_directory_id = parseInt(libraryId);

                const response = await fetch(`${API_BASE}/tracks/${trackId}/move`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();
                displayResult('moveResult', data, !response.ok);
            } catch (error) {
                displayResult('moveResult', { error: error.message }, true);
            }
        }

        async function renameTrack() {
            try {
                const trackId = document.getElementById('renameTrackId').value;
                const newName = document.getElementById('renameNewName').value;

                if (!trackId || !newName) {
                    throw new Error('Track ID and New Name required');
                }

                const response = await fetch(`${API_BASE}/tracks/${trackId}/rename`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ new_name: newName })
                });

                const data = await response.json();
                displayResult('renameResult', data, !response.ok);
            } catch (error) {
                displayResult('renameResult', { error: error.message }, true);
            }
        }

        async function deleteTrack() {
            try {
                const trackId = document.getElementById('deleteTrackId').value;
                const confirm = document.getElementById('deleteConfirm').checked;

                if (!trackId) throw new Error('Track ID required');
                if (!confirm) throw new Error('Please confirm deletion');

                const response = await fetch(`${API_BASE}/tracks/${trackId}/file`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirm: true })
                });

                const data = await response.json();
                displayResult('deleteResult', data, !response.ok);
            } catch (error) {
                displayResult('deleteResult', { error: error.message }, true);
            }
        }

        // Directory Browser & Missing Media
        async function browseDirectory() {
            try {
                const libraryId = document.getElementById('browseLibraryId').value;
                const relativePath = document.getElementById('browseRelativePath').value;

                if (!libraryId) throw new Error('Library Directory ID required');

                const params = new URLSearchParams();
                if (relativePath) params.append('path', relativePath);

                const response = await fetch(`${API_BASE}/library/directories/${libraryId}/browse?${params}`);
                const data = await response.json();
                displayResult('browseResult', data, !response.ok);
            } catch (error) {
                displayResult('browseResult', { error: error.message }, true);
            }
        }

        async function getMissingStats() {
            try {
                const libraryId = document.getElementById('missingStatsLibraryId').value;
                if (!libraryId) throw new Error('Library Directory ID required');

                const response = await fetch(`${API_BASE}/library/directories/${libraryId}/missing/stats`);
                const data = await response.json();
                displayResult('missingStatsResult', data, !response.ok);
            } catch (error) {
                displayResult('missingStatsResult', { error: error.message }, true);
            }
        }

        async function getMissingTracks() {
            try {
                const libraryId = document.getElementById('missingTracksLibraryId').value;
                const page = document.getElementById('missingTracksPage').value || 1;
                const limit = document.getElementById('missingTracksLimit').value || 20;

                if (!libraryId) throw new Error('Library Directory ID required');

                const response = await fetch(`${API_BASE}/library/directories/${libraryId}/missing?page=${page}&limit=${limit}`);
                const data = await response.json();
                displayResult('missingTracksResult', data, !response.ok);
            } catch (error) {
                displayResult('missingTracksResult', { error: error.message }, true);
            }
        }

        async function cleanupMissingTracks() {
            try {
                const libraryId = document.getElementById('cleanupLibraryId').value;
                const olderThan = document.getElementById('cleanupOlderThan').value || 30;
                const keepPlaylists = document.getElementById('cleanupKeepPlaylists').checked;
                const backup = document.getElementById('cleanupBackup').checked;

                if (!libraryId) throw new Error('Library Directory ID required');

                const response = await fetch(`${API_BASE}/library/directories/${libraryId}/cleanup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        remove_missing_older_than_days: parseInt(olderThan),
                        keep_playlists_intact: keepPlaylists,
                        backup_metadata: backup
                    })
                });

                const data = await response.json();
                displayResult('cleanupResult', data, !response.ok);
            } catch (error) {
                displayResult('cleanupResult', { error: error.message }, true);
            }
        }

        async function restoreTracks() {
            try {
                const libraryId = document.getElementById('restoreLibraryId').value;
                if (!libraryId) throw new Error('Library Directory ID required');

                const response = await fetch(`${API_BASE}/library/directories/${libraryId}/restore`, {
                    method: 'POST'
                });

                const data = await response.json();
                displayResult('restoreResult', data, !response.ok);
            } catch (error) {
                displayResult('restoreResult', { error: error.message }, true);
            }
        }

        // Run all tests
        async function runAllTests() {
            const results = [];
            const addResult = (name, success, data) => {
                results.push({ test: name, success, data });
            };

            try {
                // Test 1: Get tracks
                try {
                    const res = await fetch(`${API_BASE}/tracks?page=1&limit=5`);
                    const data = await res.json();
                    addResult('Get Tracks', res.ok, data);
                } catch (e) {
                    addResult('Get Tracks', false, e.message);
                }

                // Test 2: Get duplicate stats
                try {
                    const res = await fetch(`${API_BASE}/duplicates/stats`);
                    const data = await res.json();
                    addResult('Get Duplicate Stats', res.ok, data);
                } catch (e) {
                    addResult('Get Duplicate Stats', false, e.message);
                }

                // Test 3: List duplicate groups
                try {
                    const res = await fetch(`${API_BASE}/duplicates?page=1&limit=5`);
                    const data = await res.json();
                    addResult('List Duplicate Groups', res.ok, data);
                } catch (e) {
                    addResult('List Duplicate Groups', false, e.message);
                }

                // Test 4: Browse directory
                try {
                    const res = await fetch(`${API_BASE}/library/directories/1/browse`);
                    const data = await res.json();
                    addResult('Browse Directory', res.ok, data);
                } catch (e) {
                    addResult('Browse Directory', false, e.message);
                }

                // Test 5: Missing track stats
                try {
                    const res = await fetch(`${API_BASE}/library/directories/1/missing/stats`);
                    const data = await res.json();
                    addResult('Missing Track Stats', res.ok, data);
                } catch (e) {
                    addResult('Missing Track Stats', false, e.message);
                }

                displayResult('allTestsResult', {
                    summary: `${results.filter(r => r.success).length}/${results.length} tests passed`,
                    results
                });
            } catch (error) {
                displayResult('allTestsResult', { error: error.message }, true);
            }
        }

        // Check server status on load
        checkServerStatus();
        setInterval(checkServerStatus, 30000); // Check every 30 seconds
    </script>
</body>
</html>
